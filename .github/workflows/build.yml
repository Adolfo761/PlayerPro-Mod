name: Build PlayerPro MOD (Final)

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Install Apktool
        run: |
          mkdir -p bin
          curl -L https://raw.githubusercontent.com/iBotPeaches/Apktool/master/scripts/linux/apktool -o bin/apktool
          curl -L https://github.com/iBotPeaches/Apktool/releases/download/v2.9.3/apktool_2.9.3.jar -o bin/apktool.jar
          chmod +x bin/apktool bin/apktool.jar
          echo "$GITHUB_WORKSPACE/bin" >> $GITHUB_PATH
          ./bin/apktool --version

      - name: ðŸ› ï¸ Aplicar Parches (El Mod)
        run: |
          if [ -f "scripts/patch.sh" ]; then
            chmod +x scripts/patch.sh
            echo "Ejecutando script de parches..."
            ./scripts/patch.sh
          else
            echo "âš ï¸ ALERTA: No se encontrÃ³ scripts/patch.sh. La app se compilarÃ¡ sin mods."
          fi

      - name: Sanitize Resources (Solo lStar)
        run: |
          echo "Preservando mapa de recursos original (No delete public.xml)..."
          echo "Eliminando atributo lStar conflictivo..."
          find res/ -name "*.xml" -type f -exec sed -i 's/android:lStar="[^"]*"//g' {} +
          find res/ -name "*.xml" -type f -exec sed -i 's/android:attr\/lStar="[^"]*"//g' {} +

      - name: Build APK
        run: |
          mkdir -p dist
          apktool b . --use-aapt2 -o dist/app_unsigned.apk

      - name: âœï¸ Firmar APK Manualmente
        run: |
          echo "${{ secrets.SIGNING_KEY }}" | base64 -d > release.keystore
          BUILD_TOOLS_PATH=$(ls -d $ANDROID_HOME/build-tools/* | sort -V | tail -n 1)
          $BUILD_TOOLS_PATH/zipalign -v -p 4 dist/app_unsigned.apk dist/app_aligned.apk
          $BUILD_TOOLS_PATH/apksigner sign --ks release.keystore --ks-key-alias "${{ secrets.ALIAS }}" --ks-pass pass:"${{ secrets.KEY_PASSWORD }}" --key-pass pass:"${{ secrets.KEY_PASSWORD }}" --out dist/PlayerPro_MOD_Final.apk dist/app_aligned.apk

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: PlayerPro-MOD-Final
          path: dist/PlayerPro_MOD_Final.apk
