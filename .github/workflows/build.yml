name: Compilar Player Pro Mod

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Chequear C√≥digo
        uses: actions/checkout@v4

      - name: Configurar Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Instalar Apktool
        run: |
          wget -q -O apktool https://raw.githubusercontent.com/iBotPeaches/Apktool/master/scripts/linux/apktool
          wget -q -O apktool.jar https://bitbucket.org/iBotPeaches/apktool/downloads/apktool_2.9.3.jar
          sudo mv apktool /usr/local/bin/apktool
          sudo mv apktool.jar /usr/local/bin/apktool.jar
          sudo chmod +x /usr/local/bin/apktool
          sudo chmod +x /usr/local/bin/apktool.jar
          apktool -version

      - name: üõ†Ô∏è Aplicar Parches
        run: |
          if [ -f "scripts/patch.sh" ]; then
            chmod +x scripts/patch.sh
            ./scripts/patch.sh
          else
            echo "‚ö†Ô∏è No se encontr√≥ scripts/patch.sh, omitiendo parches."
          fi

      - name: üîì DESBLOQUEAR RECURSOS (Fix Inconsistent Count)
        run: |
          echo "üî• Borrando public.xml para regenerar IDs de recursos..."
          # Esto obliga a apktool a recrear la tabla de recursos desde cero
          find res/values -name "public.xml" -delete
          echo "‚úÖ public.xml eliminado."

      - name: üßπ Sanitizar Recursos (Fix lStar Seguro)
        run: |
          echo "üõ°Ô∏è Eliminando atributo lStar de forma segura..."
          # Reemplaza solo el texto del atributo, NO borra la l√≠nea completa
          grep -rl "android:lStar" res/ | xargs sed -i 's/android:lStar="[^"]*"//g' || true
          grep -rl "android:attr/lStar" res/ | xargs sed -i 's/android:attr\/lStar//g' || true
          echo "‚úÖ Limpieza completada."

      - name: üì¶ Recompilar APK
        run: |
          mkdir -p dist
          # Usamos --use-aapt2 para m√°xima compatibilidad
          apktool b . --use-aapt2 -o dist/app_unsigned.apk

      - name: ‚úçÔ∏è Firmar APK
        uses: r0adkll/sign-android-release@v1
        id: sign_app
        with:
          releaseDirectory: dist
          signingKeyBase64: ${{ secrets.SIGNING_KEY }}
          alias: ${{ secrets.ALIAS }}
          keyStorePassword: ${{ secrets.KEY_PASSWORD }}
          keyPassword: ${{ secrets.KEY_PASSWORD }}
        env:
          BUILD_TOOLS_VERSION: "34.0.0"

      - name: üì§ Subir APK Final
        uses: actions/upload-artifact@v4
        with:
          name: PlayerPro-Modificado
          path: ${{ steps.sign_app.outputs.signedReleaseFile }}
