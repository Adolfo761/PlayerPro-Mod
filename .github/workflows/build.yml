name: Build PlayerPro (Fix Crash)

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Install Apktool
        run: |
          mkdir -p bin
          curl -L https://raw.githubusercontent.com/iBotPeaches/Apktool/master/scripts/linux/apktool -o bin/apktool
          curl -L https://github.com/iBotPeaches/Apktool/releases/download/v2.9.3/apktool_2.9.3.jar -o bin/apktool.jar
          chmod +x bin/apktool bin/apktool.jar
          echo "$GITHUB_WORKSPACE/bin" >> $GITHUB_PATH
          ./bin/apktool --version

      - name: Sanitize Resources (Solo lStar)
        run: |
          # IMPORTANTE: NO borramos public.xml esta vez para no romper los IDs.
          echo "Preservando mapa de recursos original..."
          echo "Eliminando atributo lStar conflictivo..."
          find res/ -name "*.xml" -type f -exec sed -i 's/android:lStar="[^"]*"//g' {} +
          find res/ -name "*.xml" -type f -exec sed -i 's/android:attr\/lStar="[^"]*"//g' {} +

      - name: Build APK
        run: |
          mkdir -p dist
          # Si esto falla, sabremos que es imposible compilar sin romper los IDs
          apktool b . --use-aapt2 -o dist/app_unsigned.apk

      - name: ✍️ Firmar APK Manualmente
        run: |
          echo "${{ secrets.SIGNING_KEY }}" | base64 -d > release.keystore
          BUILD_TOOLS_PATH=$(ls -d $ANDROID_HOME/build-tools/* | sort -V | tail -n 1)
          $BUILD_TOOLS_PATH/zipalign -v -p 4 dist/app_unsigned.apk dist/app_aligned.apk
          $BUILD_TOOLS_PATH/apksigner sign --ks release.keystore --ks-key-alias "${{ secrets.ALIAS }}" --ks-pass pass:"${{ secrets.KEY_PASSWORD }}" --key-pass pass:"${{ secrets.KEY_PASSWORD }}" --out dist/PlayerPro_FixCrash.apk dist/app_aligned.apk

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: PlayerPro-FixCrash
          path: dist/PlayerPro_FixCrash.apk
